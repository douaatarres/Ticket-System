pipeline {
  agent   any

  stages { 
    stage('Checkout') {
      steps {
        git url: 'https://github.com/douaatarres/Ticket-System.git'
        sh 'node -v'
        sh 'npm -v'
      }
    }

    stage('Install Dependencies') {
      steps {
        sh '''
          for dir in auth tickets orders expiration payments client
          do
            if [ -f "$dir/package.json" ]; then
              cd $dir
              npm install
              cd ..
            fi
          done
        '''
      }
    }

    stage('OWASP Dependency Check') {
      steps {
        dependencyCheck additionalArguments: '--scan . --format XML --failOnCVSS 7',
                        odcInstallation: 'DP-Check'
        dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
      }
    }
    
    stage('SonarQube Analysis') {
      steps {
        script {
            def scannerHome = tool 'sonar'
            withSonarQubeEnv('sonar') {
                sh """
                  ${scannerHome}/bin/sonar-scanner \
                  -Dsonar.projectKey=Ticket-System \
                  -Dsonar.sources=. \
                  -Dsonar.javascript.lcov.reportPaths=auth/coverage/lcov.info,tickets/coverage/lcov.info,orders/coverage/lcov.info,expiration/coverage/lcov.info,payments/coverage/lcov.info
                """
            }
        }
    }
}
    stage('Build Docker Images') {
      steps {
        script {
          sh '''
            for dir in auth tickets orders expiration payments client
            do
              if [ -f "$dir/Dockerfile" ]; then
              docker build -t douaa/$dir:${BUILD_NUMBER} ./$dir
              fi
            done
          '''
        }
      }
    }
}
}

