pipeline {
  agent   any

  stages { 
    stage('Checkout') {
      steps {
        git url: 'https://github.com/douaatarres/Ticket-System.git'
        sh 'node -v'
        sh 'npm -v'
      }
    }

    stage('Install Dependencies') {
      steps {
        sh '''
          for dir in auth tickets orders expiration payments client
          do
            if [ -f "$dir/package.json" ]; then
              cd $dir
              npm install
              cd ..
            fi
          done
        '''
      }
    }

    stage('OWASP Dependency Check') {
      steps {
        dependencyCheck additionalArguments: '--scan . --format XML --failOnCVSS 7',
                        odcInstallation: 'DP-Check'
        dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
      }
    }
    
    stage('SonarQube Analysis') {
      steps {
        script {
            def scannerHome = tool 'sonar'
            withSonarQubeEnv('sonar') {
                sh """
                    ${scannerHome}/bin/sonar-scanner \
                    -Dsonar.projectKey=Ticket-System \
                    -Dsonar.sources=. \
                    -Dsonar.javascript.lcov.reportPaths=**/coverage/lcov.info

                """
            }
        }
    }
}
}
}

