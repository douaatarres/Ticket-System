pipeline {
  agent   any

  stages { 
    stage('Checkout') {
      steps {
        git url: 'https://github.com/douaatarres/Ticket-System.git'
        sh 'node -v'
        sh 'npm -v'
      }
    }

    stage('Install Dependencies') {
      steps {
        sh '''
          for dir in auth tickets orders expiration payments client
          do
            if [ -f "$dir/package.json" ]; then
              cd $dir
              npm install
              cd ..
            fi
          done
        '''
      }
    }  
    stage('Dependency Check') {
      steps {
        sh '''
          dependency-check.sh \
          --project "Ticket-System" \
          --scan . \
          --format XML \
          --out dependency-check-report
        '''
          dependencyCheckPublisher(
            pattern: 'dependency-check-report/dependency-check-report.xml',
            failedTotalCritical: 1
        )
    }
}
    stage('SonarQube Analysis') {
      steps {
        script {
            def scannerHome = tool 'sonar'
            withSonarQubeEnv('sonar') {
                sh """
                    ${scannerHome}/bin/sonar-scanner \
                    -Dsonar.projectKey=Ticket-System \
                    -Dsonar.sources=. 
                """
            }
        }
    }
}
}
}

